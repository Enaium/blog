<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Java革命性ORM框架Jimmer简单介绍</title><link rel=stylesheet href=/css/bootstrap.min.css></head><body class="d-flex flex-column justify-content-between min-vh-100"><nav class="navbar navbar-expand-lg bg-light"><div class=container-fluid><a class=navbar-brand href=/><img src=https://simpleicons.org/icons/github.svg alt=Logo width=30 height=24 class="d-inline-block align-text-top">
Enaium's Blog</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/contact/>Contact</a></li><li class=nav-item><a class=nav-link aria-current=page href=https://blog.enaium.cn/about/>About</a></li></ul></div></div></nav><div style=flex:1><div class=container><div class=card><div class=card-header>Java革命性ORM框架Jimmer简单介绍</div><div class=card-body><div class=card-text><p>本文使用<code>Jimmer</code>的<a href=https://github.com/babyfish-ct/jimmer/tree/main/example/java/jimmer-sql>官方用例</a>来介绍<code>Jimmer</code>的使用方法,<code>Jimmer</code>同时支持<code>Java</code>和<code>Kotlin</code>,本文使用<code>Java</code>来介绍,实际上<code>Kotlin</code>比<code>Java</code>使用起来更方便,这里为了方便大家理解,使用<code>Java</code>来介绍,本篇文章只是对<code>Jimmer</code>的一个简单介绍,更多的内容请参考<a href=https://babyfish-ct.github.io/jimmer/>官方文档</a></p><p>这里开始就不从实体类开始介绍了,这里简单的把用到的三张表之间的关系介绍一下:</p><ul><li><code>BookStore</code>书店 可以拥有多个<code>Book</code></li><li><code>Book</code>书 可以属于多个<code>BookStore</code>,可以有多个<code>Author</code></li><li><code>Author</code>作者 可以拥有多个<code>Book</code>,多对多书与作者的关系.</li></ul><h2 id=查询>查询</h2><p><code>Jimmer</code>可以配合<code>SpringData</code>(不是<code>SpringDataJPA</code>),但这里先介绍脱离<code>SpringData</code>的使用方法,但还是在<code>SpringBoot</code>环境下,这里使用<code>H2</code>内存数据库,<code>Jimmer</code>支持<code>H2</code>,<code>MySQL</code>,<code>PostgreSQL</code>,<code>Oracle</code>等数据库,这里使用<code>H2</code>内存数据库.</p><p>这里的查询都使用<code>Controller</code>来演示.</p><h3 id=查询所有书店>查询所有书店</h3><p><code>createQuery</code>就是创建一个查询,<code>select</code>就是选择要查询的字段,这里直接传入了<code>BookStoreTable</code>表示查询所有字段.</p><p>这里用到的<code>sql</code>就是使用<code>Jimmer</code>的<code>Sql</code>对象,这个对象是<code>Jimmer</code>的核心对象,所有的查询都是通过这个对象来实现的,使用<code>Spring</code>的注入方式注入<code>JSqlClient</code>对象.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> BookStoreTable bookStore <span style=color:#f92672>=</span> BookStoreTable<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>;</span><span style=color:#75715e>//这里的$是一个静态方法,返回一个BookStoreTable对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>查询结果如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;createdTime&#34;</span>: <span style=color:#e6db74>&#34;2023-05-27 11:00:37&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;modifiedTime&#34;</span>: <span style=color:#e6db74>&#34;2023-05-27 11:00:37&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;O&#39;REILLY&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;website&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;createdTime&#34;</span>: <span style=color:#e6db74>&#34;2023-05-27 11:00:37&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;modifiedTime&#34;</span>: <span style=color:#e6db74>&#34;2023-05-27 11:00:37&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;MANNING&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;website&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h3 id=指定查询字段>指定查询字段</h3><p>如何需要需要查询指定字段就可以这样,这里的<code>name</code>是<code>BookStoreTable</code>的一个字段,但这里的<code>Controller</code>返回的是<code>BookStore</code>对象,所以只好像上面的那样查询所有字段.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>像上面的例子中如果我们非要查询指定字段又不想定义新的<code>DTO</code>对象,那么这种在<code>Jimmer</code>中也可以非常简单的实现,那就是使用<code>Jimmer</code>中的<code>Fetchr</code></p><p>使用<code>BookStore</code>的<code>Fetchr</code>来指定查询的字段</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span>BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>查询结果如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;MANNING&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;O&#39;REILLY&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>惊奇的发现,<code>Controller</code>的返回类型是<code>BookStore</code>,但是查询结果中只有<code>id</code>和<code>name</code>字段.</p><p>这里我把完整的<code>Controller</code>代码贴出来,<code>List</code>的类型就是<code>BookStore</code>的实体类,这就是<code>Jimmer</code>的强大之处,不需要定义<code>DTO</code>对象,就可以实现查询指定字段的功能.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/simpleList&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>BookStore<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findSimpleStores</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> BookStoreTable bookStore <span style=color:#f92672>=</span> BookStoreTable<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>;</span><span style=color:#75715e>//这里的$是一个静态方法,返回一个BookStoreTable对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span>BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>())).</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>和实体类的<code>Table</code>一样,<code>Fetcher</code>也可以声明一个静态常量.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Fetcher<span style=color:#f92672>&lt;</span>BookStore<span style=color:#f92672>&gt;</span> SIMPLE_FETCHER <span style=color:#f92672>=</span> BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>这样就可以这样使用了.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span>SIMPLE_FETCHER<span style=color:#f92672>)).</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>接下来详细介绍<code>Fetcher</code>的使用</p><p>查询所有标量字段,也就是非关联字段.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Fetcher<span style=color:#f92672>&lt;</span>BookStore<span style=color:#f92672>&gt;</span> DEFAULT_FETCHER <span style=color:#f92672>=</span> BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>.</span><span style=color:#a6e22e>allScalarFields</span><span style=color:#f92672>();</span><span style=color:#75715e>//这里的allScalarFields()就是查询所有标量字段
</span></span></span></code></pre></div><p>在查询所有标量字段的基础上不查询<code>BookStore</code>的<code>name</code>字段</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Fetcher<span style=color:#f92672>&lt;</span>BookStore<span style=color:#f92672>&gt;</span> DEFAULT_FETCHER <span style=color:#f92672>=</span> BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>.</span><span style=color:#a6e22e>allScalarFields</span><span style=color:#f92672>().</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span><span style=color:#75715e>//这里的name(false)就是不查询name字段
</span></span></span></code></pre></div><h3 id=指定查询关联字段>指定查询关联字段</h3><p>像这样查询所有书店的所有书籍,并且查询书籍的所有作者,这样就可以使用<code>Fetcher</code>来实现,如果在使用传统<code>ORM</code>框架时,这里就需要定义一个<code>DTO</code>对象来接收查询结果,但是在<code>Jimmer</code>中,不需要定义<code>DTO</code>对象,就可以实现查询指定字段的功能,可能有读者会问了,没有<code>DTO</code>前端怎么接收数据呢,这里先剧透一下,<code>Jimmer</code>会根据后端写的<code>Fetcher</code>来生成前端的<code>DTO</code>,这里就不多说了,后面会详细介绍.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Fetcher<span style=color:#f92672>&lt;</span>BookStore<span style=color:#f92672>&gt;</span> WITH_ALL_BOOKS_FETCHER <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>allScalarFields</span><span style=color:#f92672>()</span><span style=color:#75715e>//查询所有标量字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>books</span><span style=color:#f92672>(</span><span style=color:#75715e>//查询关联字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        BookFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#75715e>//书籍的Fetcher
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#f92672>.</span><span style=color:#a6e22e>allScalarFields</span><span style=color:#f92672>()</span><span style=color:#75715e>//查询所有标量字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#f92672>.</span><span style=color:#a6e22e>authors</span><span style=color:#f92672>(</span><span style=color:#75715e>//查询关联字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                        AuthorFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#75715e>//作者的Fetcher
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                                <span style=color:#f92672>.</span><span style=color:#a6e22e>allScalarFields</span><span style=color:#f92672>()</span><span style=color:#75715e>//查询所有标量字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>);</span>
</span></span></code></pre></div><p>稍剧透一点,这里如果使用<code>Kotlin</code>来编写会更加简洁,因为<code>Kotlin</code>中的<code>DSL</code>特性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> WITH_ALL_BOOKS_FETCHER = newFetcher(BookStore<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>).<span style=color:#66d9ef>by</span> {
</span></span><span style=display:flex><span>            allScalarFields()<span style=color:#75715e>//查询所有标量字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            books {<span style=color:#75715e>//查询关联字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                allScalarFields()<span style=color:#75715e>//查询所有标量字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                authors {<span style=color:#75715e>//查询关联字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    allScalarFields()<span style=color:#75715e>//查询所有标量字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>这么一看<code>Kotlin</code>确实比<code>Java</code>简洁很多,但本篇文章还是介绍的是<code>Java</code>的使用方法.</p><h3 id=指定查询条件和计算结果字段>指定查询条件和计算结果字段</h3><p>如果需要查询书店中所有书籍的平均价格,那么就要查询书店中所有书籍的价格,然后计算平均值,这里先把查询的代码写出来,然后在介绍如何把计算结果字段添加到<code>Fetcher</code>中.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>)</span><span style=color:#75715e>//这里的bookStore是一个BookStoreTable对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>where</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>().</span><span style=color:#a6e22e>in</span><span style=color:#f92672>(</span>ids<span style=color:#f92672>))</span><span style=color:#75715e>//要查询的书店的id集合,也可以直接指定id,比如.eq(1L)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>groupBy</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>())</span><span style=color:#75715e>//按照书店的id分组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(),</span><span style=color:#75715e>//查询书店的id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>asTableEx</span><span style=color:#f92672>().</span><span style=color:#a6e22e>books</span><span style=color:#f92672>(</span>JoinType<span style=color:#f92672>.</span><span style=color:#a6e22e>LEFT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>price</span><span style=color:#f92672>().</span><span style=color:#a6e22e>avg</span><span style=color:#f92672>().</span><span style=color:#a6e22e>coalesce</span><span style=color:#f92672>(</span>BigDecimal<span style=color:#f92672>.</span><span style=color:#a6e22e>ZERO</span><span style=color:#f92672>)</span><span style=color:#75715e>//查询书店中所有书籍的平均价格
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span><span style=color:#75715e>//这样执行查询后,返回的结果就是书店的id和书店中所有书籍的平均价格,在Jimmer中会返回一个List&lt;Tuple2&lt;...&gt;&gt;类型的结果,其中Tuple元组的数量和查询的字段数量一致,这里就是2个字段,所以就是Tuple2
</span></span></span></code></pre></div><p>这里最后的<code>select</code>是查出了书店的 id 和书店中所有书籍的平均价格,<code>asTableEx()</code>是为了突破<code>Jimmer</code>的限制,<code>Jimmer</code>中的<code>Table</code>只能查询标量字段,而不能查询关联字段,这里的<code>asTableEx()</code>就是为了查询关联字段,<code>asTableEx()</code>的参数是<code>JoinType</code>,这里的<code>JoinType</code>是<code>LEFT</code>,表示左连接,如果不指定<code>JoinType</code>,默认是<code>INNER</code>,表示内连接.</p><p>这里的<code>avg()</code>是计算平均值的意思,<code>coalesce(BigDecimal.ZERO)</code>是为了防止计算结果为<code>null</code>,如果计算结果为<code>null</code>,那么就返回<code>BigDecimal.ZERO</code>.</p><p>这里介绍如何把计算结果字段添加到<code>Fetcher</code>中,这样就又引出了一个<code>Jimmer</code>的功能<code>计算属性</code></p><h3 id=计算属性>计算属性</h3><p>在<code>Jimmer</code>中如果要添加计算属性,那么就要实现<code>TransientResolver</code>接口,这里先把代码贴出来,然后再详细介绍.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BookStoreAvgPriceResolver</span> <span style=color:#66d9ef>implements</span> TransientResolver<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> BigDecimal<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>,</span> BigDecimal<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>resolve</span><span style=color:#f92672>(</span>Collection<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里的<code>ids</code>就是书店的 id 集合,这里的<code>resolve</code>方法就是计算书店中所有书籍的平均价格,这里的<code>Long</code>是书店的 id,<code>BigDecimal</code>是书店中所有书籍的平均价格,这里的<code>resolve</code>方法返回的<code>Map</code>的<code>key</code>就是书店的 id,<code>value</code>就是书店中所有书籍的平均价格.</p><p>接着配合上面写的查询代码,完成计算的代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>BookStoreTable bookStore <span style=color:#f92672>=</span> BookStoreTable<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>where</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>().</span><span style=color:#a6e22e>in</span><span style=color:#f92672>(</span>ids<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>groupBy</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>asTableEx</span><span style=color:#f92672>().</span><span style=color:#a6e22e>books</span><span style=color:#f92672>(</span>JoinType<span style=color:#f92672>.</span><span style=color:#a6e22e>LEFT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>price</span><span style=color:#f92672>().</span><span style=color:#a6e22e>avg</span><span style=color:#f92672>().</span><span style=color:#a6e22e>coalesce</span><span style=color:#f92672>(</span>BigDecimal<span style=color:#f92672>.</span><span style=color:#a6e22e>ZERO</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span><span style=color:#75715e>//这里的execute()返回的结果是List&lt;Tuple2&lt;Long, BigDecimal&gt;&gt;类型的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>()</span><span style=color:#75715e>//这里把List转换成Stream
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>collect</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                Collectors<span style=color:#f92672>.</span><span style=color:#a6e22e>toMap</span><span style=color:#f92672>(</span>Tuple2<span style=color:#f92672>::</span>get_1<span style=color:#f92672>,</span> Tuple2<span style=color:#f92672>::</span>get_2<span style=color:#f92672>)</span><span style=color:#75715e>//这里把List&lt;Tuple2&lt;Long, BigDecimal&gt;&gt;转换成Map&lt;Long, BigDecimal&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这样一个<code>TransientResolver</code>的实现就完成了,接着就是把<code>TransientResolver</code>添加到实体类中</p><p><code>Jimmer</code>中定义实体类是在接口中定义的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transient</span><span style=color:#f92672>(</span>BookStoreAvgPriceResolver<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span><span style=color:#75715e>//这里的BookStoreAvgPriceResolver.class就是上面写的计算属性的实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>BigDecimal <span style=color:#a6e22e>avgPrice</span><span style=color:#f92672>();</span><span style=color:#75715e>//这里的avgPrice()就是计算属性,这里的BigDecimal就是计算属性的类型
</span></span></span></code></pre></div><p>这样就可以直接在<code>Fetcher</code>中查询计算属性了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Fetcher<span style=color:#f92672>&lt;</span>BookStore<span style=color:#f92672>&gt;</span> WITH_ALL_BOOKS_FETCHER <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            BookStoreFetcher<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>allScalarFields</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>avgPrice</span><span style=color:#f92672>()</span><span style=color:#75715e>//这里就是查询计算属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>//...省略
</span></span></span></code></pre></div><p>接着看戏生成的<code>SQL</code>代码和查询结果,这里照样省略其他查询只关注标量字段和计算属性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span>
</span></span><span style=display:flex><span>    tb_1_.ID,
</span></span><span style=display:flex><span>    coalesce(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>avg</span>(tb_2_.PRICE), <span style=color:#f92672>?</span> <span style=color:#75715e>/* 0 */</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> BOOK_STORE tb_1_
</span></span><span style=display:flex><span><span style=color:#66d9ef>left</span> <span style=color:#66d9ef>join</span> BOOK tb_2_
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>on</span> tb_1_.ID <span style=color:#f92672>=</span> tb_2_.STORE_ID
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    tb_1_.ID <span style=color:#66d9ef>in</span> (
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> <span style=color:#75715e>/* 1 */</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span><span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span>
</span></span><span style=display:flex><span>    tb_1_.ID
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;createdTime&#34;</span>: <span style=color:#e6db74>&#34;2023-05-27 12:04:39&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;modifiedTime&#34;</span>: <span style=color:#e6db74>&#34;2023-05-27 12:04:39&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;O&#39;REILLY&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;website&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;avgPrice&#34;</span>: <span style=color:#ae81ff>58.5</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=定义实体类>定义实体类</h2><p>在<code>Jimmer</code>中定义实体类是在接口中定义的,这里先把代码贴出来,然后再详细介绍.</p><h3 id=bookstore>BookStore</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Entity</span><span style=color:#75715e>//这里的@Entity就是实体类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BookStore</span> <span style=color:#66d9ef>extends</span> BaseEntity <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span><span style=color:#75715e>//这里的@Id就是主键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@GeneratedValue</span><span style=color:#f92672>(</span>strategy <span style=color:#f92672>=</span> GenerationType<span style=color:#f92672>.</span><span style=color:#a6e22e>IDENTITY</span><span style=color:#f92672>)</span><span style=color:#75715e>//这里的strategy = GenerationType.IDENTITY就是自增长
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>();</span><span style=color:#75715e>//这里的id()就是实体类的id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Key</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>name</span><span style=color:#f92672>();</span><span style=color:#75715e>//业务主键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Null</span><span style=color:#75715e>//这里的@Null就是可以为null,建议使用Jetbrains的@Nullable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String <span style=color:#a6e22e>website</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OneToMany</span><span style=color:#f92672>(</span>mappedBy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;store&#34;</span><span style=color:#f92672>,</span> orderedProps <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@OrderedProp</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@OrderedProp</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;edition&#34;</span><span style=color:#f92672>,</span> desc <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>})</span><span style=color:#75715e>//这里的@OneToMany就是一对多,这里的mappedBy = &#34;store&#34;就是Book中的store字段,这里的orderedProps就是排序字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>Book<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>books</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transient</span><span style=color:#f92672>(</span>BookStoreAvgPriceResolver<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span><span style=color:#75715e>//这里的BookStoreAvgPriceResolver.class就是上面写的计算属性的实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    BigDecimal <span style=color:#a6e22e>avgPrice</span><span style=color:#f92672>();</span><span style=color:#75715e>//这里的avgPrice()就是计算属性,这里的BigDecimal就是计算属性的类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=book>Book</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Book</span> <span style=color:#66d9ef>extends</span> TenantAware <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GeneratedValue</span><span style=color:#f92672>(</span>strategy <span style=color:#f92672>=</span> GenerationType<span style=color:#f92672>.</span><span style=color:#a6e22e>IDENTITY</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Key</span><span style=color:#75715e>//这里的@Key就是业务主键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    String <span style=color:#a6e22e>name</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Key</span><span style=color:#75715e>//和上面的name()一样,这里的@Key就是业务主键,表示name和edition的组合是唯一的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>edition</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    BigDecimal <span style=color:#a6e22e>price</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Nullable</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ManyToOne</span>
</span></span><span style=display:flex><span>    BookStore <span style=color:#a6e22e>store</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ManyToMany</span><span style=color:#f92672>(</span>orderedProps <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@OrderedProp</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;firstName&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@OrderedProp</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;lastName&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>})</span><span style=color:#75715e>//这里的@ManyToMany就是多对多,这里的orderedProps就是排序字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@JoinTable</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;BOOK_AUTHOR_MAPPING&#34;</span><span style=color:#f92672>,</span><span style=color:#75715e>//这里的name就是中间表的表名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            joinColumnName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;BOOK_ID&#34;</span><span style=color:#f92672>,</span><span style=color:#75715e>//这里的joinColumnName就是中间表的外键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            inverseJoinColumnName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AUTHOR_ID&#34;</span><span style=color:#75715e>//这里的inverseJoinColumnName就是中间表的外键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Author<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>authors</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=author>Author</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Author</span> <span style=color:#66d9ef>extends</span> BaseEntity <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GeneratedValue</span><span style=color:#f92672>(</span>strategy <span style=color:#f92672>=</span> GenerationType<span style=color:#f92672>.</span><span style=color:#a6e22e>IDENTITY</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Key</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>firstName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Key</span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>lastName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Gender <span style=color:#a6e22e>gender</span><span style=color:#f92672>();</span><span style=color:#75715e>//这里的Gender就是枚举类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ManyToMany</span><span style=color:#f92672>(</span>mappedBy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;authors&#34;</span><span style=color:#f92672>,</span> orderedProps <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@OrderedProp</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@OrderedProp</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;edition&#34;</span><span style=color:#f92672>,</span> desc <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>})</span><span style=color:#75715e>//这里的@ManyToMany就是多对多,这里的mappedBy = &#34;authors&#34;就是Book中的authors字段,这里的orderedProps就是排序字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>Book<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>books</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> Gender <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@EnumItem</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;M&#34;</span><span style=color:#f92672>)</span><span style=color:#75715e>//这里的name表示在数据库中存储的值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MALE<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@EnumItem</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;F&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    FEMALE
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果使用过<code>Spring Data JPA</code>的话,这里的代码应该很熟悉,<code>Jimmer</code>中的实体类的关联关系和<code>Spring Data JPA</code>中的关联关系是一样的.</p><h2 id=生成前端代码>生成前端代码</h2><p>还记得前面的剧透吗,现在开始正式介绍如何生成前端代码,这里先把生成的代码贴出来,然后再详细介绍.</p><h3 id=dto>DTO</h3><p>这里生成了好多根据<code>Controller</code>的返回类型的<code>Fetcher</code>生成的<code>DTO</code>,这里就不贴出来了,只贴一个<code>BookStoreDto</code>的代码.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>BookStoreDto</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>//只有查询书店的name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;BookStoreService/SIMPLE_FETCHER&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>//查询书店的所有字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;BookStoreService/DEFAULT_FETCHER&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>createdTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>modifiedTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>website?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>//查询书店的所有字段和书店中所有书籍的所有字段还有书籍的所有作者的所有字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;BookStoreService/WITH_ALL_BOOKS_FETCHER&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>createdTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>modifiedTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>website?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>avgPrice</span>: <span style=color:#66d9ef>number</span> <span style=color:#75715e>//这里的avgPrice就是计算属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>books</span>: <span style=color:#66d9ef>ReadonlyArray</span><span style=color:#f92672>&lt;</span>{
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>createdTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>modifiedTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>edition</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>price</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>authors</span>: <span style=color:#66d9ef>ReadonlyArray</span><span style=color:#f92672>&lt;</span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>createdTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>modifiedTime</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>firstName</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>lastName</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>gender</span>: <span style=color:#66d9ef>Gender</span>
</span></span><span style=display:flex><span>      }<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    }<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=controller>Controller</h3><p>这里只看<code>BookStoreController</code>的主要请求</p><p>这里<code>Jimmer</code>把所有的<code>Controller</code>的请求都放在了一个<code>Controller</code>中,这里的<code>Controller</code>就是<code>BookStoreController</code>,这里的<code>BookStoreController</code>就是<code>BookStore</code>实体类的<code>Controller</code>,这里的<code>BookStoreController</code>的代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findComplexStoreWithAllBooks</span>(<span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>BookStoreServiceOptions</span>[<span style=color:#e6db74>&#39;findComplexStoreWithAllBooks&#39;</span>])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BookStoreDto</span>[<span style=color:#e6db74>&#39;BookStoreService/WITH_ALL_BOOKS_FETCHER&#39;</span>] <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>_uri</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/bookStore/&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_uri</span> <span style=color:#f92672>+=</span> encodeURIComponent(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_uri</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;/withAllBooks&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executor</span>({<span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>_uri</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>})) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>BookStoreDto</span>[<span style=color:#e6db74>&#39;BookStoreService/WITH_ALL_BOOKS_FETCHER&#39;</span>] <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findSimpleStores</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReadonlyArray</span>&lt;<span style=color:#f92672>BookStoreDto</span><span style=color:#960050;background-color:#1e0010>[&#39;</span><span style=color:#a6e22e>BookStoreService</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>SIMPLE_FETCHER</span><span style=color:#960050;background-color:#1e0010>&#39;]</span>&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>_uri</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/bookStore/simpleList&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executor</span>({<span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>_uri</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>})) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ReadonlyArray</span>&lt;<span style=color:#f92672>BookStoreDto</span><span style=color:#960050;background-color:#1e0010>[&#39;</span><span style=color:#a6e22e>BookStoreService</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>SIMPLE_FETCHER</span><span style=color:#960050;background-color:#1e0010>&#39;]</span>&gt;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#a6e22e>findStores</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReadonlyArray</span>&lt;<span style=color:#f92672>BookStoreDto</span><span style=color:#960050;background-color:#1e0010>[&#39;</span><span style=color:#a6e22e>BookStoreService</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>DEFAULT_FETCHER</span><span style=color:#960050;background-color:#1e0010>&#39;]</span>&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>_uri</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/bookStore/list&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executor</span>({<span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>_uri</span>, <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>})) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ReadonlyArray</span>&lt;<span style=color:#f92672>BookStoreDto</span><span style=color:#960050;background-color:#1e0010>[&#39;</span><span style=color:#a6e22e>BookStoreService</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>DEFAULT_FETCHER</span><span style=color:#960050;background-color:#1e0010>&#39;]</span>&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=配置代码生成>配置代码生成</h3><p>需要再配置中指定生成代码的访问地址,因为<code>Jimmer</code>生成的前端代码是一个压缩包,访问这个地址就可以下载生成的源码了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jimmer</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>client</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ts</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/ts.zip</span> <span style=color:#75715e>#这里的path就是访问地址</span>
</span></span></code></pre></div><p>接着配置<code>Controller</code>的返回类型</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/simpleList&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>@FetchBy</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SIMPLE_FETCHER&#34;</span><span style=color:#f92672>)</span> BookStore<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findSimpleStores</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> BookStoreTable bookStore <span style=color:#f92672>=</span> BookStoreTable<span style=color:#f92672>.</span><span style=color:#a6e22e>$</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sql<span style=color:#f92672>.</span><span style=color:#a6e22e>createQuery</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>).</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>bookStore<span style=color:#f92672>.</span><span style=color:#a6e22e>fetch</span><span style=color:#f92672>(</span>SIMPLE_FETCHER<span style=color:#f92672>)).</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里使用了<code>FetchBy</code>注解,其中的值就是当前类的<code>Fetcher</code>常量,如果<code>Fetcher</code>不在当前的类下,可以指定注解中的<code>ownerType</code>来指定<code>Fetcher</code>所在的类.</p><p>好了,<code>Jimmer</code>的基本使用就介绍完了,如果想了解更多的使用方法,可以查看<code>Jimmer</code>的<a href=https://babyfish-ct.github.io/jimmer/>文档</a>,也可以观看<code>Jimmer</code>作者录制的视频教程<a href=https://www.bilibili.com/video/BV1wD4y1L7xr>Jimmer0.6x: 前后端免对接+spring starter，让REST媲美GraphQL</a>,<a href=https://www.bilibili.com/video/BV1NM4y1C78H>Jimmer-0.7之计算属性</a></p></div></div></div></div></div><footer class="p-5 bg-dark text-white text-center"><div class=container><p class=lead>Copyright &copy; 2022 Enaium</p></div></footer><script src=/js/bootstrap.bundle.min.js></script></body></html>